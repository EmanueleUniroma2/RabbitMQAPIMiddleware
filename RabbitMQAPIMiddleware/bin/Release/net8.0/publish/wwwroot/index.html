<!DOCTYPE html>
<html lang="it" class="h-full bg-[#1e1e1e]">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RabbitMQ Bridge - VS Code Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              gray: {
                950: "#0d0d0d",
                900: "#1e1e1e",
                800: "#252526",
                700: "#333333",
                600: "#3c3c3c",
                500: "#858585",
                400: "#cccccc",
              },
              blue: { 600: "#007acc", 500: "#007acc" },
            },
            keyframes: {
              slideIn: {
                "0%": { transform: "translateX(100%)", opacity: "0" },
                "100%": { transform: "translateX(0)", opacity: "1" },
              },
            },
            animation: { slideIn: "slideIn 0.3s ease-out forwards" },
          },
        },
      };
    </script>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        font-size: 13px;
        color: #cccccc;
        margin: 0;
        overflow: hidden;
      }
      .vscode-sidebar {
        background-color: #252526;
      }
      .vscode-input {
        background-color: #3c3c3c;
        border: 1px solid #3c3c3c;
        color: #cccccc;
      }
      .vscode-input:focus {
        border-color: #007acc;
        outline: none;
      }
      .vscode-button {
        background-color: #007acc;
        color: #ffffff;
        transition: all 0.1s;
      }
      .vscode-button:active {
        transform: scale(0.98);
      }
      .queue-item.active {
        background-color: #37373d;
        border-left: 2px solid #007acc;
        color: white;
      }
      pre {
        font-family: "Consolas", monospace;
        font-size: 12px;
      }

      /* Toast Styles (Keep CSS for transition but logic is now handled by Bridge) */
      .toast-container {
        position: fixed;
        bottom: 30px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .toast {
        background: #252526;
        border: 1px solid #333;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        padding: 12px 16px;
        min-width: 300px;
        border-left: 4px solid #007acc;
      }

      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }
      ::-webkit-scrollbar-thumb {
        background: #424242;
        border: 2px solid transparent;
        background-clip: content-box;
      }
    </style>
  </head>
  <body class="h-full flex flex-col">
    <div id="toastContainer" class="toast-container"></div>

    <div
      id="modal-overlay"
      class="fixed inset-0 z-[100] bg-black/60 flex items-center justify-center hidden backdrop-blur-[2px]"
    >
      <div
        class="w-full max-w-sm vscode-sidebar border border-[#454545] shadow-2xl p-6"
      >
        <h3 id="modal-title" class="text-white font-bold mb-2"></h3>
        <p
          id="modal-message"
          class="text-sm text-gray-400 mb-6 font-mono whitespace-pre-wrap"
        ></p>
        <div class="flex justify-end space-x-3">
          <button
            id="modal-cancel"
            class="px-4 py-1.5 text-xs bg-[#3c3c3c] hover:bg-[#454545] text-white hidden"
          >
            Annulla
          </button>
          <button
            id="modal-ok"
            class="px-4 py-1.5 text-xs vscode-button font-bold"
          >
            OK
          </button>
        </div>
      </div>
    </div>

    <div
      id="login-screen"
      class="fixed inset-0 z-50 flex items-center justify-center bg-gray-950 hidden"
    >
      <div
        class="bg-gray-800 border border-gray-700 p-8 rounded shadow-2xl w-80"
      >
        <div class="flex flex-col items-center mb-6 text-white">
          <i data-lucide="zap" class="w-12 h-12 text-blue-500 mb-2"></i>
          <h2 class="text-lg font-semibold uppercase tracking-widest">
            Rabbit Bridge
          </h2>
        </div>
        <div class="space-y-4">
          <input
            type="text"
            id="username"
            placeholder="Username"
            class="w-full bg-gray-900 border border-gray-700 p-2 rounded focus:outline-none focus:border-blue-500 text-white text-xs"
          />
          <input
            type="password"
            id="password"
            placeholder="Password"
            class="w-full bg-gray-900 border border-gray-700 p-2 rounded focus:outline-none focus:border-blue-500 text-white text-xs"
          />
          <button
            onclick="manualLogin()"
            class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-500 transition font-medium text-xs"
          >
            Connect
          </button>
          <div
            id="login-error"
            class="text-red-400 text-[10px] text-center hidden italic"
          >
            Credenziali errate
          </div>
        </div>
      </div>
    </div>

    <div id="app" class="flex flex-col h-full hidden">
      <header
        class="h-9 border-b border-gray-700 flex items-center justify-between px-3 bg-gray-900 select-none"
      >
        <div class="flex items-center gap-4">
          <span
            class="text-[11px] font-bold tracking-widest text-gray-500 uppercase"
            >RabbitMQ Middleware</span
          >
        </div>
        <button
          id="logout-btn"
          onclick="logout()"
          class="hover:text-red-400 transition hidden"
        >
          <i data-lucide="log-out" class="w-4 h-4"></i>
        </button>
      </header>

      <div class="flex flex-1 overflow-hidden">
        <aside
          class="w-64 vscode-sidebar flex flex-col border-r border-gray-700"
        >
          <div
            class="p-3 text-[10px] uppercase font-bold text-gray-500 flex justify-between items-center bg-gray-900/50"
          >
            <span>Queues Explorer</span>
            <i
              data-lucide="rotate-cw"
              onclick="loadQueues()"
              class="w-3 h-3 cursor-pointer hover:text-white"
            ></i>
          </div>
          <nav id="queue-list" class="flex-1 overflow-y-auto"></nav>
        </aside>

        <main class="flex-1 flex flex-col bg-gray-950 overflow-hidden">
          <div
            id="queue-toolbar"
            class="h-10 bg-gray-900 flex items-center px-4 justify-between border-b border-gray-800 hidden"
          >
            <h2
              id="selected-queue-name"
              class="text-blue-400 font-bold uppercase text-[11px] tracking-widest"
            ></h2>
            <div class="flex gap-2">
              <button
                onclick="confirmAction('Svuotare la coda?', purgeQueue)"
                class="text-[10px] text-gray-500 hover:text-white uppercase font-bold px-2 py-1"
              >
                Purge
              </button>
              <button
                onclick="confirmAction('Eliminare la coda?', deleteQueue)"
                class="text-[10px] text-red-500 hover:text-red-400 uppercase font-bold px-2 py-1"
              >
                Delete
              </button>
            </div>
          </div>

          <div class="flex-1 grid grid-cols-2 overflow-hidden">
            <div class="border-r border-gray-800 flex flex-col overflow-hidden">
              <div
                class="p-2 bg-gray-900/50 text-[10px] uppercase font-bold text-gray-500 flex justify-between items-center border-b border-gray-800"
              >
                <span>Messages Peek</span>
                <span
                  id="msg-count-badge"
                  class="bg-blue-600 text-white px-1 rounded text-[9px]"
                  >0</span
                >
              </div>
              <div
                id="messages-container"
                class="flex-1 overflow-y-auto p-4 space-y-3"
              ></div>
            </div>

            <div class="flex flex-col p-6 space-y-6 overflow-y-auto">
              <section>
                <h3
                  class="text-[10px] font-bold mb-3 text-gray-500 uppercase tracking-widest border-l-2 border-blue-500 pl-2"
                >
                  Publish Message
                </h3>
                <div class="space-y-3">
                  <input
                    type="text"
                    id="target-queue-name"
                    class="w-full p-2 bg-gray-900 border border-gray-700 rounded text-xs text-white focus:border-blue-500 outline-none"
                    placeholder="Target queue name..."
                  />
                  <textarea
                    id="publish-payload"
                    rows="8"
                    class="w-full p-2 bg-gray-900 border border-gray-700 rounded text-xs text-white font-mono focus:border-blue-500 outline-none"
                    placeholder='{ "id": 1 }'
                  ></textarea>
                  <button
                    onclick="publishMessage()"
                    class="w-full py-2 bg-blue-600 hover:bg-blue-500 text-white text-[11px] font-bold rounded shadow-lg transition uppercase tracking-tighter"
                  >
                    Publish to RabbitMQ
                  </button>
                </div>
              </section>
              <section
                id="receive-section"
                class="border-t border-gray-800 pt-6 hidden"
              >
                <h3
                  class="text-[10px] font-bold mb-2 text-gray-500 uppercase tracking-widest border-l-2 border-amber-500 pl-2"
                >
                  Destructive Receive
                </h3>
                <button
                  onclick="confirmAction('Ricevere e rimuovere il prossimo messaggio?', receiveMessage)"
                  class="w-full py-2 bg-amber-600/10 border border-amber-600/30 text-amber-500 hover:bg-amber-600/20 text-[11px] font-bold rounded transition uppercase"
                >
                  Get Next (ACK)
                </button>
              </section>
            </div>
          </div>
        </main>
      </div>

      <footer
        class="h-6 bg-blue-600 flex items-center px-3 justify-between text-[10px] text-white"
      >
        <div id="last-refresh">Sincronizzazione...</div>
        <div class="font-mono uppercase">Status: Connected</div>
      </footer>
    </div>

    <script>
      let currentQueue = null;
      const API = {
        login: "/api/login",
        loginSecret: "/api/login/secret",
        queues: "/api/mgmt/queues",
        peek: (q) => `/api/mgmt/queues/${q}/peek`,
        receive: (q) => `/api/messages/${q}/receive`,
        publish: (q) => `/api/messages/${q}`,
      };

      // --- NOTIFICATION SYSTEM (Iframe Bridge to App Manager) ---
      const showNotification = (message, type = "info") => {
        window.parent.postMessage({
          type: 'SHOW_NOTIFICATION',
          payload: {
            message: message,
            notificationType: type
          }
        }, '*');
      };

      // --- MODALS ---
      function confirmAction(msg, action) {
        document.getElementById("modal-title").innerText = "Conferma";
        document.getElementById("modal-message").innerText = msg;
        document.getElementById("modal-cancel").classList.remove("hidden");
        document.getElementById("modal-overlay").classList.remove("hidden");
        document.getElementById("modal-ok").onclick = () => {
          document.getElementById("modal-overlay").classList.add("hidden");
          action();
        };
        document.getElementById("modal-cancel").onclick = () =>
          document.getElementById("modal-overlay").classList.add("hidden");
      }

      async function customAlert(title, message) {
        document.getElementById("modal-title").innerText = title;
        document.getElementById("modal-message").innerText = message;
        document.getElementById("modal-cancel").classList.add("hidden");
        document.getElementById("modal-overlay").classList.remove("hidden");
        document.getElementById("modal-ok").onclick = () =>
          document.getElementById("modal-overlay").classList.add("hidden");
      }

      // --- AUTH ---
      window.onload = async () => {
        lucide.createIcons();
        const s = new URLSearchParams(window.location.search).get("secret");
        if (s) await autoLogin(s);
        else if (localStorage.getItem("token")) {
          checkAuth();
          showApp();
        } else showLogin();
      };

      async function autoLogin(secret) {
        const res = await fetch(API.loginSecret, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ secret }),
        });
        if (res.ok) {
          const data = await res.json();
          localStorage.setItem("token", data.token);
          localStorage.setItem("secret_session", "true");
          window.history.replaceState({}, "", window.location.pathname);
          checkAuth();
          showApp();
          showNotification("Auto-login success", "success");
        } else showLogin();
      }

      async function manualLogin() {
        const res = await fetch(API.login, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            username: document.getElementById("username").value,
            password: document.getElementById("password").value,
          }),
        });
        if (res.ok) {
          const data = await res.json();
          localStorage.setItem("token", data.token);
          localStorage.setItem("secret_session", "false");
          checkAuth();
          showApp();
          showNotification("Connection established", "success");
        } else {
          document.getElementById("login-error").classList.remove("hidden");
          showNotification("Invalid credentials", "error");
        }
      }

      function checkAuth() {
        const isSecret = localStorage.getItem("secret_session") === "true";
        document
          .getElementById("logout-btn")
          .classList.toggle("hidden", isSecret);
      }

      function showApp() {
        document.getElementById("login-screen").classList.add("hidden");
        document.getElementById("app").classList.remove("hidden");
        loadQueues();
        setInterval(loadQueues, 2000);
      }

      function showLogin() {
        document.getElementById("login-screen").classList.remove("hidden");
        document.getElementById("app").classList.add("hidden");
      }
      function logout() {
        localStorage.clear();
        showLogin();
      }

      // --- API CORE ---
      async function req(url, method = "GET", body = null) {
        const res = await fetch(url, {
          method,
          headers: {
            Authorization: `Bearer ${localStorage.getItem("token")}`,
            "Content-Type": "application/json",
          },
          body: body ? JSON.stringify(body) : null,
        });
        if (res.status === 401) logout();
        return res;
      }

      async function loadQueues() {
        const res = await req(API.queues);
        if (res.ok) {
          const queues = await res.json();
          document.getElementById("queue-list").innerHTML = queues
            .map(
              (q) => `
                    <div onclick="selectQueue('${q.name}')" id="q-${
                q.name
              }" class="queue-item px-4 py-2 cursor-pointer hover:bg-gray-700/30 flex justify-between items-center ${
                currentQueue === q.name ? "active active-tab bg-gray-800" : ""
              }">
                        <span class="truncate ${
                          currentQueue === q.name
                            ? "text-white font-bold"
                            : "text-gray-400"
                        }">${q.name}</span>
                        <span class="text-[9px] font-bold px-1.5 rounded-full ${
                          q.messages > 0
                            ? "bg-blue-600 text-white"
                            : "bg-gray-700 text-gray-500"
                        }">${q.messages}</span>
                    </div>
                `
            )
            .join("");
          document.getElementById("last-refresh").innerText =
            "Last sync: " + new Date().toLocaleTimeString();
        }
      }

      function selectQueue(name) {
        document
          .querySelectorAll(".queue-item")
          .forEach((el) => el.classList.remove("active", "bg-gray-800"));
        const el = document.getElementById(`q-${name}`);
        if (el) el.classList.add("active", "bg-gray-800");

        currentQueue = name;
        document.getElementById("queue-toolbar").classList.remove("hidden");
        document.getElementById("receive-section").classList.remove("hidden");
        document.getElementById("selected-queue-name").innerText = name;
        document.getElementById("target-queue-name").value = name;
        peekMessages();
      }

      async function peekMessages() {
        const res = await req(API.peek(currentQueue));
        const container = document.getElementById("messages-container");
        if (res.ok) {
          const msgs = await res.json();
          document.getElementById("msg-count-badge").innerText = msgs.length;
          container.innerHTML = msgs.length
            ? msgs
                .map((m, i) => {
                  let p = m.payload;
                  try {
                    p = JSON.stringify(JSON.parse(m.payload), null, 2);
                  } catch (e) {}
                  return `<div class="p-3 bg-gray-900 border border-gray-800 rounded shadow-md animate-slideIn"><div class="text-[9px] text-blue-500 font-bold uppercase mb-1">Index #${
                    i + 1
                  }</div><pre class="text-gray-300 whitespace-pre-wrap">${p}</pre></div>`;
                })
                .join("")
            : '<div class="text-center mt-10 text-gray-600 italic">No messages found</div>';
          lucide.createIcons();
        }
      }

      async function publishMessage() {
        const target = document.getElementById("target-queue-name").value;
        const payloadStr = document.getElementById("publish-payload").value;
        if (!target)
          return showNotification("Target queue is required", "error");
        try {
          const res = await req(
            API.publish(target),
            "POST",
            JSON.parse(payloadStr)
          );
          if (res.ok) {
            showNotification("Message published to " + target, "success");
            setTimeout(() => {
              loadQueues();
              if (currentQueue === target) peekMessages();
            }, 600);
          } else showNotification("Publish failed", "error");
        } catch (e) {
          showNotification("Invalid JSON payload", "error");
        }
      }

      async function receiveMessage() {
        const res = await req(API.receive(currentQueue), "POST");
        if (res.ok) {
          const d = await res.json();
          await customAlert(
            "Message Popped",
            JSON.stringify(JSON.parse(d.payload), null, 2)
          );
          showNotification("Message consumed", "info");
          peekMessages();
          loadQueues();
        } else showNotification("Queue might be empty", "error");
      }

      async function purgeQueue() {
        const res = await req(`/api/mgmt/queues/${currentQueue}/purge`, "POST");
        if (res.ok) {
          showNotification("Queue purged", "success");
          peekMessages();
          loadQueues();
        }
      }

      async function deleteQueue() {
        const res = await req(`/api/mgmt/queues/${currentQueue}`, "DELETE");
        if (res.ok) {
          showNotification("Queue deleted", "info");
          currentQueue = null;
          document.getElementById("queue-toolbar").classList.add("hidden");
          document.getElementById("receive-section").classList.add("hidden");
          loadQueues();
        }
      }
    </script>
  </body>
</html>